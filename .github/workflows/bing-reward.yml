name: Bing Reward 定时执行

on:
  schedule:
    - cron: '0 0 * * *'  # 北京时间8点执行（UTC 0点）
  workflow_dispatch:

jobs:
  run-bing-reward:
    runs-on: ubuntu-22.04
    permissions:
      contents: read

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 打印目录结构（排查路径）
        run: |
          pwd
          ls -la

      - name: 安装环境依赖
        run: |
          # 修复 Windows 换行符（方案1：无临时文件）
          tr -d '\r' < setup_ubuntu.sh > setup_ubuntu_fixed.sh && mv setup_ubuntu_fixed.sh setup_ubuntu.sh
          tr -d '\r' < start_bing_reward.sh > start_bing_reward_fixed.sh && mv start_bing_reward_fixed.sh start_bing_reward.sh
          # 赋予执行权限
          chmod +x setup_ubuntu.sh
          sudo ./setup_ubuntu.sh

      - name: 检查虚拟环境是否创建
        run: |
          if [ -d "./venv" ]; then
            echo "✅ 虚拟环境创建成功"
            ls -la ./venv/bin/
          else
            echo "❌ 虚拟环境创建失败！"
            exit 1
          fi

      - name: 运行 Bing 奖励脚本
        run: |
          chmod +x start_bing_reward.sh
          ./start_bing_reward.sh

      - name: 保存运行日志
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: bing-reward-logs
          path: |
            ./*log*
            /tmp/*
